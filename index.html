<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bike Fit Cockpit Calculator</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üö¥</text></svg>">
<style>
  :root {
    --bg: #1a1a2e;
    --bg-card: #16213e;
    --bg-input: #0f3460;
    --accent: #e94560;
    --accent-dim: #c73650;
    --text: #eee;
    --text-dim: #999;
    --text-label: #bbb;
    --green: #4ecca3;
    --yellow: #f0c040;
    --red: #e94560;
    --border: #2a2a4a;
    --radius: 8px;
    --svg-grid: #1a1a2e;
    --svg-frame: #555;
    --svg-dim-subtle: #555;
    --svg-text-subtle: #666;
    --svg-ground: #2a2a4a;
    --svg-bb-label: #999;
  }

  :root.light {
    --bg: #f0f2f5;
    --bg-card: #fff;
    --bg-input: #f7f8fa;
    --text: #1a1a2e;
    --text-dim: #666;
    --text-label: #555;
    --border: #d0d5dd;
    --svg-grid: #e8eaed;
    --svg-frame: #888;
    --svg-dim-subtle: #999;
    --svg-text-subtle: #888;
    --svg-ground: #ccc;
    --svg-bb-label: #777;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    line-height: 1.5;
    transition: background-color 0.3s, color 0.3s;
  }

  header {
    background: var(--bg-card);
    border-bottom: 2px solid var(--accent);
    padding: 16px 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 12px;
  }

  header h1 {
    font-size: 1.4rem;
    font-weight: 700;
    letter-spacing: -0.5px;
  }

  header h1 span { color: var(--accent); }

  .mode-toggle {
    display: flex;
    background: var(--bg);
    border-radius: var(--radius);
    overflow: hidden;
    border: 1px solid var(--border);
  }

  .mode-toggle button {
    padding: 8px 16px;
    border: none;
    background: transparent;
    color: var(--text-dim);
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 500;
    transition: all 0.2s;
    white-space: nowrap;
  }

  .mode-toggle button.active {
    background: var(--accent);
    color: #fff;
  }

  .mode-toggle button:hover:not(.active) {
    color: var(--text);
    background: var(--border);
  }

  main {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
  }

  .card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
  }

  .card h2 {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 16px;
    color: var(--accent);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-size: 0.85rem;
  }

  .input-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  .input-group {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .input-group label {
    font-size: 0.75rem;
    color: var(--text-label);
    font-weight: 500;
  }

  .input-group input {
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 8px 10px;
    color: var(--text);
    font-size: 0.9rem;
    width: 100%;
    font-family: inherit;
    transition: border-color 0.2s;
  }

  .input-group input:focus {
    outline: none;
    border-color: var(--accent);
  }

  .input-group input:disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }

  .input-group .unit {
    font-size: 0.7rem;
    color: var(--text-dim);
  }

  .results-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  .result-item {
    background: var(--bg);
    border-radius: 6px;
    padding: 12px;
    text-align: center;
  }

  .result-item .result-label {
    font-size: 0.7rem;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
  }

  .info-tip {
    cursor: help;
    font-size: 0.85rem;
    color: var(--accent);
    vertical-align: middle;
    position: relative;
  }

  .inline-result {
    font-size: 0.72rem;
    color: var(--accent);
    margin-top: 2px;
    cursor: help;
    position: relative;
  }

  .tip-text {
    display: none;
    position: absolute;
    bottom: 100%;
    left: 0;
    background: var(--bg-input);
    color: var(--text);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 8px 10px;
    font-size: 0.7rem;
    line-height: 1.4;
    width: 260px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    z-index: 100;
    margin-bottom: 4px;
    text-transform: none;
    letter-spacing: normal;
    font-weight: 400;
  }

  .inline-result:hover .tip-text,
  .label-tip:hover .tip-text,
  .inline-result.tip-active .tip-text,
  .label-tip.tip-active .tip-text {
    display: block;
  }

  .label-tip {
    cursor: help;
    color: var(--accent);
    position: relative;
    font-style: normal;
  }

  .result-item .result-value {
    font-size: 1.4rem;
    font-weight: 700;
    font-variant-numeric: tabular-nums;
  }

  .result-item .result-unit {
    font-size: 0.7rem;
    color: var(--text-dim);
  }

  .result-item.highlight {
    border: 1px solid var(--accent);
  }

  .result-good .result-value { color: var(--green); }
  .result-warn .result-value { color: var(--yellow); }
  .result-bad .result-value { color: var(--red); }

  .diagram-container {
    grid-column: 1 / -1;
  }

  .diagram-container svg {
    width: 100%;
    height: auto;
    display: block;
  }

  .constraint-section {
    margin-bottom: 16px;
    padding: 12px;
    background: var(--bg);
    border-radius: 6px;
  }

  .constraint-section label {
    font-size: 0.8rem;
    color: var(--text-label);
    display: block;
    margin-bottom: 8px;
  }

  .constraint-section select {
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 6px 10px;
    color: var(--text);
    font-size: 0.85rem;
    width: 100%;
    font-family: inherit;
  }

  .constraint-section select:focus {
    outline: none;
    border-color: var(--accent);
  }

  .reverse-results {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-top: 12px;
  }

  .reverse-result {
    background: var(--bg);
    border: 1px solid var(--green);
    border-radius: 6px;
    padding: 12px;
    text-align: center;
  }

  .reverse-result .rr-label {
    font-size: 0.7rem;
    color: var(--text-dim);
    text-transform: uppercase;
    margin-bottom: 4px;
  }

  .reverse-result .rr-value {
    font-size: 1.3rem;
    font-weight: 700;
    color: var(--green);
    font-variant-numeric: tabular-nums;
  }

  .reverse-result .rr-unit {
    font-size: 0.7rem;
    color: var(--text-dim);
  }

  .reverse-result.rr-warn {
    border-color: var(--yellow);
  }

  .reverse-result.rr-warn .rr-value {
    color: var(--yellow);
  }

  .reverse-result.rr-bad {
    border-color: var(--red);
  }

  .reverse-result.rr-bad .rr-value {
    color: var(--red);
  }

  .note {
    font-size: 0.75rem;
    color: var(--text-dim);
    margin-top: 8px;
    font-style: italic;
  }

  .theme-toggle {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 6px 12px;
    color: var(--text-dim);
    cursor: pointer;
    font-size: 0.85rem;
    font-family: inherit;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .theme-toggle:hover {
    color: var(--text);
    border-color: var(--accent);
  }

  .theme-toggle .theme-icon { font-size: 1rem; }

  .header-controls {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
  }

  footer {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px 20px 32px;
    text-align: center;
    color: var(--text-dim);
    font-size: 0.8rem;
    border-top: 1px solid var(--border);
  }

  .preset-trigger {
    margin-top: 12px;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .preset-trigger-btn {
    background: var(--accent);
    border: none;
    border-radius: var(--radius);
    padding: 8px 20px;
    color: #fff;
    cursor: pointer;
    font-size: 0.85rem;
    font-family: inherit;
    font-weight: 600;
    transition: all 0.2s;
  }

  .preset-trigger-btn:hover {
    background: var(--accent-dim);
  }

  .preset-active-label {
    font-size: 0.8rem;
    color: var(--text-dim);
    font-style: italic;
  }

  .info-btn {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 6px 12px;
    color: var(--text-dim);
    cursor: pointer;
    font-size: 0.85rem;
    font-family: inherit;
    transition: all 0.2s;
  }

  .info-btn:hover {
    color: var(--text);
    border-color: var(--accent);
  }

  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
    z-index: 1000;
    justify-content: center;
    align-items: center;
    padding: 20px;
  }

  .modal-overlay.open {
    display: flex;
  }

  .modal {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    max-width: 640px;
    width: 100%;
    max-height: 80vh;
    overflow-y: auto;
    padding: 28px;
    position: relative;
  }

  .modal h2 {
    color: var(--accent);
    font-size: 1.1rem;
    margin-bottom: 16px;
  }

  .modal h3 {
    color: var(--text);
    font-size: 0.9rem;
    margin-top: 16px;
    margin-bottom: 6px;
  }

  .modal p, .modal li {
    font-size: 0.85rem;
    color: var(--text-dim);
    line-height: 1.6;
  }

  .modal ul {
    padding-left: 20px;
    margin-bottom: 8px;
  }

  .modal li { margin-bottom: 4px; }

  .modal-close {
    position: absolute;
    top: 12px;
    right: 16px;
    background: none;
    border: none;
    color: var(--text-dim);
    font-size: 1.4rem;
    cursor: pointer;
    line-height: 1;
  }

  .modal-close:hover { color: var(--accent); }

  /* Preset Modal */
  .preset-modal {
    max-width: 700px;
    max-height: 85vh;
  }

  .preset-search {
    width: 100%;
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 10px 14px;
    color: var(--text);
    font-size: 0.9rem;
    font-family: inherit;
    margin-bottom: 16px;
  }

  .preset-search:focus {
    outline: none;
    border-color: var(--accent);
  }

  .preset-search::placeholder {
    color: var(--text-dim);
  }

  .preset-brand {
    margin-bottom: 8px;
    border: 1px solid var(--border);
    border-radius: 6px;
    overflow: hidden;
  }

  .preset-brand-header {
    background: var(--bg);
    padding: 10px 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-weight: 600;
    font-size: 0.95rem;
    user-select: none;
    transition: background 0.2s;
  }

  .preset-brand-header:hover {
    background: var(--border);
  }

  .preset-brand-header .chevron {
    transition: transform 0.2s;
    font-size: 0.8rem;
    color: var(--text-dim);
  }

  .preset-brand.open .chevron {
    transform: rotate(90deg);
  }

  .preset-brand-body {
    display: none;
    padding: 8px 14px 14px;
  }

  .preset-brand.open .preset-brand-body {
    display: block;
  }

  .preset-model {
    margin-bottom: 10px;
  }

  .preset-model:last-child {
    margin-bottom: 0;
  }

  .preset-model-name {
    font-size: 0.8rem;
    color: var(--text-label);
    font-weight: 500;
    margin-bottom: 6px;
  }

  .preset-model-name .model-year {
    color: var(--text-dim);
    font-weight: 400;
  }

  .preset-sizes {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }

  .preset-size-btn {
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 5px 12px;
    color: var(--text);
    cursor: pointer;
    font-size: 0.78rem;
    font-family: inherit;
    font-weight: 600;
    transition: all 0.2s;
  }

  .preset-size-btn:hover {
    border-color: var(--accent);
    color: var(--accent);
  }

  .preset-size-btn.no-data {
    opacity: 0.35;
    cursor: not-allowed;
  }

  .preset-size-btn.no-data:hover {
    border-color: var(--border);
    color: var(--text);
  }

  /* Compare Frames */
  .compare-selectors {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
  }

  .compare-frame-selector {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 16px;
    text-align: center;
  }

  .compare-frame-selector h3 {
    font-size: 0.85rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
  }

  .compare-frame-selector.frame-a h3 { color: var(--accent); }
  .compare-frame-selector.frame-b h3 { color: var(--green); }

  .compare-frame-label {
    font-size: 0.85rem;
    color: var(--text-dim);
    margin-bottom: 12px;
    font-style: italic;
    min-height: 1.3em;
  }

  .compare-diagram {
    margin-bottom: 20px;
  }

  .compare-diagram svg {
    width: 100%;
    height: auto;
    display: block;
  }

  .compare-legend {
    display: flex;
    justify-content: center;
    gap: 24px;
    margin-top: 8px;
    font-size: 0.8rem;
    color: var(--text-dim);
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .legend-swatch {
    display: inline-block;
    width: 14px;
    height: 3px;
    border-radius: 2px;
  }

  .compare-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.85rem;
  }

  .compare-table th,
  .compare-table td {
    padding: 10px 14px;
    text-align: center;
    border-bottom: 1px solid var(--border);
  }

  .compare-table th {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-dim);
    font-weight: 600;
  }

  .compare-table td.compare-metric {
    text-align: left;
    font-weight: 500;
    color: var(--text-label);
  }

  .compare-table td.compare-val-a {
    color: var(--accent);
    font-weight: 600;
    font-variant-numeric: tabular-nums;
  }

  .compare-table td.compare-val-b {
    color: var(--green);
    font-weight: 600;
    font-variant-numeric: tabular-nums;
  }

  .compare-table td.compare-diff {
    color: var(--text);
    font-weight: 600;
    font-variant-numeric: tabular-nums;
  }

  /* Hoods / Handlebars Toggle */
  .measure-toggle-wrapper {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    margin-left: 12px;
    vertical-align: middle;
    color: #fff;
    font-size: 0.75rem;
    font-weight: 500;
  }

  .measure-toggle-wrapper .separator {
    color: var(--text-dim);
    font-weight: 300;
  }

  .measure-toggle {
    display: inline-flex;
    background: var(--bg);
    border-radius: 4px;
    overflow: hidden;
    border: 1px solid var(--border);
  }

  .measure-toggle button {
    padding: 3px 10px;
    border: none;
    background: transparent;
    color: var(--text-dim);
    cursor: pointer;
    font-size: 0.75rem;
    font-family: inherit;
    font-weight: 500;
    transition: all 0.2s;
    white-space: nowrap;
  }

  .measure-toggle button.active {
    background: var(--accent);
    color: #fff;
  }

  .measure-toggle button:hover:not(.active) {
    color: var(--text);
    background: var(--border);
  }

  .hidden { display: none !important; }

  @media (max-width: 768px) {
    main {
      grid-template-columns: 1fr;
      padding: 12px;
    }
    .input-grid {
      grid-template-columns: 1fr;
    }
    header {
      padding: 12px 16px;
    }
    header h1 {
      font-size: 1.1rem;
    }
    .mode-toggle button {
      padding: 6px 12px;
      font-size: 0.8rem;
    }
    .diagram-container svg text {
      font-size: 16px !important;
    }
    .tip-text {
      left: 50% !important;
      transform: translateX(-50%);
    }
    .compare-selectors {
      grid-template-columns: 1fr;
    }
  }
</style>
<script>
// Touch-friendly tooltips: tap to toggle on mobile, close when tapping elsewhere
document.addEventListener('DOMContentLoaded', function() {
  document.addEventListener('click', function(e) {
    var tipParent = e.target.closest('.label-tip, .inline-result');
    // Close all other open tooltips
    document.querySelectorAll('.tip-active').forEach(function(el) {
      if (el !== tipParent) el.classList.remove('tip-active');
    });
    // Toggle clicked tooltip
    if (tipParent) {
      tipParent.classList.toggle('tip-active');
    }
  });
});
</script>
</head>
<body>

<header>
  <h1><span>Bike Fit</span> Cockpit Calculator</h1>
  <div class="header-controls">
    <div class="mode-toggle">
      <button id="mode-forward" class="active" onclick="setMode('forward')">Components ‚Üí Fit</button>
      <button id="mode-reverse" onclick="setMode('reverse')">Fit Targets ‚Üí Components</button>
    </div>
    <button class="info-btn" onclick="document.getElementById('instructions-modal').classList.add('open')">Instructions</button>
    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle light/dark mode">
      <span class="theme-icon" id="theme-icon">‚òÄÔ∏è</span>
      <span id="theme-label">Light</span>
    </button>
  </div>
</header>

<main>
  <!-- Frame Geometry Card -->
  <div class="card calculator-view">
    <h2>Frame Geometry</h2>
    <div class="input-grid">
      <div class="input-group">
        <label>Stack <span class="unit">(mm)</span> <span class="label-tip">&#9432;<span class="tip-text">Vertical distance from the centre of the bottom bracket to the top of the head tube. A key measurement for determining handlebar height.</span></span></label>
        <input type="number" id="stack" value="570" step="1">
      </div>
      <div class="input-group">
        <label>Reach <span class="unit">(mm)</span> <span class="label-tip">&#9432;<span class="tip-text">Horizontal distance from the centre of the bottom bracket to the top of the head tube. The primary measurement for frame length and rider stretch.</span></span></label>
        <input type="number" id="reach" value="390" step="1">
      </div>
      <div class="input-group">
        <label>Seat Tube Angle <span class="unit">(¬∞)</span> <span class="label-tip">&#9432;<span class="tip-text">Angle of the seat tube relative to horizontal. Steeper angles (higher numbers) place the saddle further forward over the BB. Typically 72¬∞‚Äì75¬∞ for road bikes.</span></span></label>
        <input type="number" id="sta" value="73.5" step="0.1">
      </div>
      <div class="input-group">
        <label>Head Tube Angle <span class="unit">(¬∞)</span> <span class="label-tip">&#9432;<span class="tip-text">Angle of the head tube relative to horizontal. Affects steering feel and how spacers/stem translate into reach and stack changes. Typically 71¬∞‚Äì74¬∞ for road bikes.</span></span></label>
        <input type="number" id="hta" value="73" step="0.1">
      </div>
    </div>
    <div class="preset-trigger">
      <button class="preset-trigger-btn" onclick="openPresetModal()">Preset Frame Sizes</button>
      <span class="preset-active-label hidden" id="active-preset-label"></span>
    </div>
    <div class="preset-trigger">
      <button class="preset-trigger-btn" onclick="setMode('compare')" style="background:var(--green)">Compare Frames</button>
    </div>
  </div>

  <!-- Mode: Forward ‚Äî Component Inputs -->
  <div class="card calculator-view" id="card-components">
    <h2>Components <span class="measure-toggle-wrapper"><span class="separator">&middot;</span> Measure to: <span class="measure-toggle"><button class="active" data-target="hoods" onclick="setMeasureTarget('hoods')">Hoods</button><button data-target="bars" onclick="setMeasureTarget('bars')">Handlebars</button></span></span></h2>
    <div class="input-grid">
      <div class="input-group">
        <label>Stem Length <span class="unit">(mm)</span> <span class="label-tip">&#9432;<span class="tip-text">Centre-to-centre length of the stem. Common road sizes are 80‚Äì130mm. Longer stems increase reach to the hoods.</span></span></label>
        <input type="number" id="stem-length" value="100" step="5">
      </div>
      <div class="input-group">
        <label>Stem Angle <span class="unit">(¬∞ from steerer)</span> <span class="label-tip">&#9432;<span class="tip-text">Angle of the stem relative to the steerer tube. Negative values (e.g. ‚àí6¬∞) angle the stem downward for a lower bar position. 0¬∞ is perpendicular to the steerer.</span></span></label>
        <input type="number" id="stem-angle" value="-6" step="1">
      </div>
      <div class="input-group">
        <label>Spacer Stack <span class="unit">(mm)</span> <span class="label-tip">&#9432;<span class="tip-text">Total height of headset spacers below the stem. Spacers raise the handlebar position. Measured along the steerer tube axis.</span></span></label>
        <input type="number" id="spacer-stack" value="20" step="5">
      </div>
      <div class="input-group">
        <label>Stem Height <span class="unit">(mm)</span> <span class="label-tip">&#9432;<span class="tip-text">Height of the stem clamp on the steerer tube. This adds to the spacer stack to determine where the stem extends from. Typically 35‚Äì45mm for standard stems.</span></span></label>
        <input type="number" id="stem-height" value="40" step="1">
      </div>
      <div class="input-group">
        <label>Handlebar Reach <span class="unit">(mm)</span> <span class="label-tip">&#9432;<span class="tip-text">Horizontal distance from the stem clamp to the brake hoods. Varies by handlebar model, typically 70‚Äì85mm for road bars.</span></span></label>
        <input type="number" id="bar-reach" value="80" step="1">
      </div>
      <div class="input-group">
        <label>Handlebar Diameter <span class="unit">(mm)</span> <span class="label-tip">&#9432;<span class="tip-text">Outer diameter of the handlebar at the clamp area. Added to the hood height calculation. Standard road bars are 31.8mm (oversized) or 26.0mm (legacy).</span></span></label>
        <input type="number" id="bar-diameter" value="31.8" step="0.1">
      </div>
      <div class="input-group">
        <label>Saddle Height <span class="unit">(mm, BB to saddle BRP)</span> <span class="label-tip">&#9432;<span class="tip-text">Distance from the centre of the bottom bracket to the saddle's Biomechanical Reference Point (BRP), measured along the seat tube. The BRP is the designed sit-bone contact point on the saddle ‚Äî typically marked by the manufacturer or approximated as the deepest point of the saddle's profile.</span></span></label>
        <input type="number" id="saddle-height" value="740" step="1">
      </div>
      <div class="input-group">
        <label>Saddle Setback <span class="unit">(mm, behind seatpost)</span> <span class="label-tip">&#9432;<span class="tip-text">Horizontal offset of the saddle BRP (Biomechanical Reference Point) behind the seatpost clamp. Most saddle rails allow 0‚Äì20mm of setback adjustment. The BRP is the designed sit-bone contact point on the saddle.</span></span></label>
        <input type="number" id="saddle-setback" value="5" step="1">
        <div class="inline-result" id="bb-setback-display"><span class="tip-text">Horizontal distance from the saddle BRP (Biomechanical Reference Point) to the bottom bracket centre. Measured along the seat tube line plus any saddle setback. Use this to set your saddle position relative to the BB (e.g. KOPS or behind-BB targets).</span></div>
      </div>
    </div>
  </div>

  <!-- Mode: Reverse ‚Äî Fit Targets + Known Components -->
  <div class="card calculator-view hidden" id="card-targets">
    <h2>Fit Targets <span class="measure-toggle-wrapper"><span class="separator">&middot;</span> Measure to: <span class="measure-toggle"><button class="active" data-target="hoods" onclick="setMeasureTarget('hoods')">Hoods</button><button data-target="bars" onclick="setMeasureTarget('bars')">Handlebars</button></span></span></h2>
    <div class="input-grid">
      <div class="input-group">
        <label><span id="label-target-reach">Target Saddle-to-Hood Reach</span> <span class="unit">(mm)</span> <span class="label-tip">&#9432;<span class="tip-text">Desired horizontal distance from the saddle BRP (Biomechanical Reference Point) to the brake hoods. This is the main measurement for how stretched out your riding position is.</span></span></label>
        <input type="number" id="target-reach" value="760" step="1">
      </div>
      <div class="input-group">
        <label><span id="label-target-drop">Target Saddle-to-Hood Drop</span> <span class="unit">(mm)</span> <span class="label-tip">&#9432;<span class="tip-text">Desired vertical drop from the saddle BRP to the brake hoods. Positive values mean the hoods are lower than the saddle. More drop = more aggressive position.</span></span></label>
        <input type="number" id="target-drop" value="100" step="1">
      </div>
      <div class="input-group">
        <label>Saddle Height <span class="unit">(mm, BB to saddle BRP)</span> <span class="label-tip">&#9432;<span class="tip-text">Distance from the centre of the bottom bracket to the saddle's Biomechanical Reference Point (BRP), measured along the seat tube. The BRP is the designed sit-bone contact point on the saddle.</span></span></label>
        <input type="number" id="target-saddle-height" value="740" step="1">
      </div>
      <div class="input-group">
        <label>Saddle Setback <span class="unit">(mm, behind seatpost)</span> <span class="label-tip">&#9432;<span class="tip-text">Horizontal offset of the saddle BRP (Biomechanical Reference Point) behind the seatpost clamp. Most saddle rails allow 0‚Äì20mm of setback adjustment.</span></span></label>
        <input type="number" id="target-saddle-setback" value="5" step="1">
        <div class="inline-result" id="bb-setback-display-reverse"><span class="tip-text">Horizontal distance from the saddle BRP (Biomechanical Reference Point) to the bottom bracket centre. Measured along the seat tube line plus any saddle setback. Use this to set your saddle position relative to the BB (e.g. KOPS or behind-BB targets).</span></div>
      </div>
      <div class="input-group">
        <label>Handlebar Reach <span class="unit">(mm)</span> <span class="label-tip">&#9432;<span class="tip-text">Horizontal distance from the stem clamp to the brake hoods. Varies by handlebar model, typically 70‚Äì85mm for road bars.</span></span></label>
        <input type="number" id="target-bar-reach" value="80" step="1">
      </div>
      <div class="input-group">
        <label>Stem Height <span class="unit">(mm)</span> <span class="label-tip">&#9432;<span class="tip-text">Height of the stem clamp on the steerer tube. This adds to the spacer stack to determine where the stem extends from. Typically 35‚Äì45mm for standard stems.</span></span></label>
        <input type="number" id="target-stem-height" value="40" step="1">
      </div>
      <div class="input-group">
        <label>Handlebar Diameter <span class="unit">(mm)</span> <span class="label-tip">&#9432;<span class="tip-text">Outer diameter of the handlebar at the clamp area. Added to the hood height calculation. Standard road bars are 31.8mm (oversized) or 26.0mm (legacy).</span></span></label>
        <input type="number" id="target-bar-diameter" value="31.8" step="0.1">
      </div>
    </div>

    <div class="constraint-section" style="margin-top: 16px;">
      <label>Fix one variable, solve for the other two:</label>
      <select id="constraint-var" onchange="recalculate()">
        <option value="stem-angle">Fix Stem Angle ‚Äî solve for Stem Length &amp; Spacers</option>
        <option value="spacers">Fix Spacer Stack ‚Äî solve for Stem Length &amp; Angle</option>
        <option value="stem-length">Fix Stem Length ‚Äî solve for Spacers &amp; Angle</option>
      </select>
    </div>

    <div class="input-grid" style="margin-top: 12px;">
      <div class="input-group" id="fix-stem-angle-group">
        <label>Fixed Stem Angle <span class="unit">(¬∞ from steerer)</span> <span class="label-tip">&#9432;<span class="tip-text">The stem angle you want to keep fixed. The solver will find the stem length and spacer stack needed to hit your fit targets.</span></span></label>
        <input type="number" id="fix-stem-angle" value="-6" step="1">
      </div>
      <div class="input-group hidden" id="fix-spacers-group">
        <label>Fixed Spacer Stack <span class="unit">(mm)</span> <span class="label-tip">&#9432;<span class="tip-text">The spacer stack you want to keep fixed. The solver will find the stem length and angle needed to hit your fit targets.</span></span></label>
        <input type="number" id="fix-spacers" value="20" step="5">
      </div>
      <div class="input-group hidden" id="fix-stem-length-group">
        <label>Fixed Stem Length <span class="unit">(mm)</span> <span class="label-tip">&#9432;<span class="tip-text">The stem length you want to keep fixed. The solver will find the spacer stack and stem angle needed to hit your fit targets.</span></span></label>
        <input type="number" id="fix-stem-length" value="100" step="5">
      </div>
    </div>

    <div class="reverse-results" id="reverse-results"></div>
    <p class="note" id="reverse-note"></p>
  </div>

  <!-- Forward Results -->
  <div class="card calculator-view" id="card-results">
    <h2>Fit Results</h2>
    <div class="results-grid" id="forward-results"></div>
    <p class="note" id="forward-note"></p>
  </div>

  <!-- SVG Diagram -->
  <div class="card diagram-container calculator-view">
    <h2>Geometry Diagram</h2>
    <svg id="bike-svg" viewBox="0 0 800 500" xmlns="http://www.w3.org/2000/svg"></svg>
  </div>

  <!-- Compare Frames View -->
  <div class="card hidden" id="compare-view" style="grid-column: 1 / -1;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
      <h2 style="margin:0;">Compare Frames</h2>
      <button class="preset-trigger-btn" onclick="setMode('forward')">&larr; Back to Calculator</button>
    </div>
    <div class="compare-selectors">
      <div class="compare-frame-selector frame-a">
        <h3>Frame A</h3>
        <div class="compare-frame-label" id="compare-label-a">No frame selected</div>
        <button class="preset-trigger-btn" onclick="openComparePresetModal('a')">Select Frame</button>
      </div>
      <div class="compare-frame-selector frame-b">
        <h3>Frame B</h3>
        <div class="compare-frame-label" id="compare-label-b">No frame selected</div>
        <button class="preset-trigger-btn" onclick="openComparePresetModal('b')" style="background:var(--green)">Select Frame</button>
      </div>
    </div>
    <div class="compare-diagram">
      <svg id="compare-svg" viewBox="0 0 800 500" xmlns="http://www.w3.org/2000/svg"></svg>
      <div class="compare-legend">
        <span class="legend-item"><span class="legend-swatch" style="background:var(--accent)"></span> Frame A</span>
        <span class="legend-item"><span class="legend-swatch" style="background:var(--green)"></span> Frame B</span>
      </div>
    </div>
    <div id="compare-table"></div>
  </div>
</main>

<div class="modal-overlay" id="instructions-modal" onclick="if(event.target===this)this.classList.remove('open')">
  <div class="modal">
    <button class="modal-close" onclick="document.getElementById('instructions-modal').classList.remove('open')">&times;</button>
    <h2>Bike Fit Cockpit Calculator</h2>
    <p>This tool helps you translate professional bike fit measurements into the specific components you need for a given frame, or check what fit numbers a particular setup produces. Frame geometry for many popular bikes is available via the built-in presets. For bikes not included, you can find geometry data on the <a href="https://geometrygeeks.bike" target="_blank" rel="noopener" style="color:var(--accent)">geometrygeeks.bike</a> database and enter the values manually.</p>

    <h3>How it works</h3>
    <p>All calculations use the geometric relationship between the bottom bracket (BB), saddle, and hood positions. The frame's stack, reach, seat tube angle, and head tube angle define the skeleton. Components (stem, spacers, handlebars) extend from the top of the head tube to the hood position along the steerer and stem axes using trigonometry.</p>

    <h3>Measure to: Hoods / Handlebars</h3>
    <p>Use the toggle next to the Components and Fit Targets headings to switch between measuring to the <strong>Hoods</strong> (brake hood position, accounting for handlebar reach) or the <strong>Handlebars</strong> (top of the bar at the stem clamp, ignoring handlebar reach). All fit results and the diagram update accordingly.</p>

    <h3>Mode 1: Components to Fit</h3>
    <p>Enter your frame geometry and the components you have (or are considering). The calculator shows the resulting fit numbers:</p>
    <ul>
      <li><strong>Saddle-to-Reach</strong> &mdash; horizontal distance from saddle to the measurement point</li>
      <li><strong>Saddle-to-Drop</strong> &mdash; how far the measurement point sits below the saddle (positive = lower)</li>
    </ul>

    <h3>Mode 2: Fit Targets to Components</h3>
    <p>Enter the fit targets from your bike fitter along with your frame geometry. The system of equations has three unknowns (stem length, stem angle, spacer stack) but only two constraints (reach and drop), so you fix one variable and solve for the other two:</p>
    <ul>
      <li><strong>Fix Stem Angle</strong> &mdash; choose your preferred stem angle, get the required stem length and spacer stack</li>
      <li><strong>Fix Spacer Stack</strong> &mdash; set your spacer height, get the required stem length and angle</li>
      <li><strong>Fix Stem Length</strong> &mdash; pick a stem length, get the required spacers and angle</li>
    </ul>

    <h3>Frame presets</h3>
    <p>Click the <strong>Presets</strong> button to open a searchable overlay with multiple bike brands and models. Each model lists its available sizes &mdash; select one to instantly load the frame geometry. Dimmed sizes are bikes we haven&rsquo;t added geometry data for yet. You can always enter or adjust the geometry fields manually for any frame.</p>

    <h3>Compare Frames</h3>
    <p>Click <strong>Compare Frames</strong> to select two frames from the database and see their geometry overlaid on the same diagram with a side-by-side comparison table.</p>

    <h3>Key inputs</h3>
    <ul>
      <li><strong>Stack &amp; Reach</strong> &mdash; from the frame geometry chart (mm)</li>
      <li><strong>Seat Tube Angle (STA)</strong> &mdash; angle from horizontal (typically 72&ndash;76&deg;)</li>
      <li><strong>Head Tube Angle (HTA)</strong> &mdash; angle from horizontal (typically 71&ndash;74&deg;)</li>
      <li><strong>Stem Angle</strong> &mdash; relative to the steerer perpendicular (0&deg; = perpendicular, negative = angled down)</li>
      <li><strong>Saddle Height</strong> &mdash; measured along the seat tube from BB centre to the saddle Biomechanical Reference Point (BRP). The BRP is the designed sit-bone contact point, usually marked by the manufacturer or at the deepest point of the saddle profile (mm)</li>
      <li><strong>Saddle Setback</strong> &mdash; horizontal offset of the saddle BRP behind the seatpost clamp (mm)</li>
      <li><strong>Handlebar Reach</strong> &mdash; horizontal distance from bar clamp to hoods (mm, from bar spec sheet)</li>
    </ul>

    <h3>Tips</h3>
    <ul>
      <li>Yellow warnings appear when a solved value is outside typical commercially available ranges</li>
      <li>If the reverse solver shows negative spacers, the frame likely has too much stack for your fit targets</li>
      <li>The diagram updates live as you adjust inputs</li>
      <li>Use the Presets button to quickly load frame geometry for popular bikes and compare sizes</li>
    </ul>
  </div>
</div>

<div class="modal-overlay" id="preset-modal" onclick="if(event.target===this)this.classList.remove('open')">
  <div class="modal preset-modal">
    <button class="modal-close" onclick="document.getElementById('preset-modal').classList.remove('open')">&times;</button>
    <h2>Select Frame Preset</h2>
    <input type="text" class="preset-search" id="preset-search" placeholder="Search brands or models..." oninput="renderPresetModal()">
    <div id="preset-list"></div>
    <p style="margin-top:16px; font-size:0.8rem; color:var(--text-dim); text-align:center;">To suggest more bikes or if any data is incorrect email jakestuchbury (at) gmail.com</p>
  </div>
</div>

<footer>
  &copy; 2026 Jake Stuchbury-Wass
</footer>

<script src="bike-database.js"></script>
<script>
// ============================================================
// Theme Toggle
// ============================================================

function toggleTheme() {
  const root = document.documentElement;
  const isLight = root.classList.toggle('light');
  document.getElementById('theme-icon').textContent = isLight ? 'üåô' : '‚òÄÔ∏è';
  document.getElementById('theme-label').textContent = isLight ? 'Dark' : 'Light';
  localStorage.setItem('bike-fit-theme', isLight ? 'light' : 'dark');
  if (currentMode === 'compare') renderCompareView();
  else recalculate(); // redraw SVG with new colors
}

// Restore saved theme
(function() {
  const saved = localStorage.getItem('bike-fit-theme');
  if (saved === 'light') {
    document.documentElement.classList.add('light');
    document.getElementById('theme-icon').textContent = 'üåô';
    document.getElementById('theme-label').textContent = 'Dark';
  }
})();

// ============================================================
// Frame Presets ‚Äî Canyon Aeroad CF SLX 2025
// ============================================================

let activePresetLabel = '';

function openPresetModal() {
  compareTarget = null; // ensure normal preset mode
  renderPresetModal();
  document.getElementById('preset-modal').classList.add('open');
  document.getElementById('preset-search').value = '';
  document.getElementById('preset-search').focus();
}

function renderPresetModal() {
  const container = document.getElementById('preset-list');
  const searchTerm = (document.getElementById('preset-search').value || '').toLowerCase();

  let html = '';

  for (const [brand, models] of Object.entries(BIKE_DATABASE).sort(([a], [b]) => a.localeCompare(b))) {
    const brandMatches = brand.toLowerCase().includes(searchTerm);
    let modelHtml = '';
    let anyModelVisible = false;

    for (const [model, data] of Object.entries(models).sort(([a], [b]) => a.localeCompare(b))) {
      const modelMatches = model.toLowerCase().includes(searchTerm) || brandMatches;
      if (!modelMatches && searchTerm) continue;

      anyModelVisible = true;
      let sizeBtns = '';
      const sizeEntries = Object.entries(data.sizes).sort(([a], [b]) => {
        const na = parseFloat(a), nb = parseFloat(b);
        if (!isNaN(na) && !isNaN(nb)) return na - nb;
        return 0; // preserve original order for non-numeric sizes (XS, S, M, etc.)
      });
      for (const [size, geo] of sizeEntries) {
        const hasData = geo.stack !== null;
        const cls = hasData ? '' : ' no-data';
        const title = hasData
          ? `Stack: ${geo.stack}mm, Reach: ${geo.reach}mm, STA: ${geo.sta}¬∞, HTA: ${geo.hta}¬∞`
          : 'Geometry data not yet entered';
        const escaped = model.replace(/'/g, "\\'");
        sizeBtns += `<button class="preset-size-btn${cls}" title="${title}" onclick="loadBikePreset('${brand}','${escaped}','${size}')">${size}</button>`;
      }

      modelHtml += `
        <div class="preset-model">
          <div class="preset-model-name">${model} <span class="model-year">(${data.year})</span></div>
          <div class="preset-sizes">${sizeBtns}</div>
        </div>
      `;
    }

    if (!anyModelVisible && searchTerm) continue;

    const openClass = searchTerm ? ' open' : '';
    html += `
      <div class="preset-brand${openClass}">
        <div class="preset-brand-header" onclick="this.parentElement.classList.toggle('open')">
          <span>${brand}</span>
          <span class="chevron">&#9654;</span>
        </div>
        <div class="preset-brand-body">${modelHtml}</div>
      </div>
    `;
  }

  if (!html) {
    html = '<p style="color:var(--text-dim);text-align:center;padding:20px;">No bikes match your search.</p>';
  }

  container.innerHTML = html;
}

function loadBikePreset(brand, model, size) {
  const geo = BIKE_DATABASE[brand]?.[model]?.sizes?.[size];
  if (!geo || geo.stack === null) return;

  // If selecting for compare mode, store to compare frame instead
  if (compareTarget) {
    const frameData = {
      brand, model, size,
      stack: geo.stack, reach: geo.reach, sta: geo.sta, hta: geo.hta
    };
    if (compareTarget === 'a') compareFrameA = frameData;
    else compareFrameB = frameData;

    const labelId = compareTarget === 'a' ? 'compare-label-a' : 'compare-label-b';
    document.getElementById(labelId).textContent = `${brand} ${model} \u2014 ${size}`;

    compareTarget = null;
    document.getElementById('preset-modal').classList.remove('open');
    renderCompareView();
    return;
  }

  document.getElementById('stack').value = geo.stack;
  document.getElementById('reach').value = geo.reach;
  document.getElementById('sta').value = geo.sta;
  document.getElementById('hta').value = geo.hta;

  activePresetLabel = `${brand} ${model} ‚Äî ${size}`;
  const label = document.getElementById('active-preset-label');
  label.textContent = activePresetLabel;
  label.classList.remove('hidden');

  document.getElementById('preset-modal').classList.remove('open');
  recalculate();
}

// Clear preset label when frame inputs are manually changed
['stack', 'reach', 'sta', 'hta'].forEach(id => {
  document.getElementById(id).addEventListener('input', () => {
    document.getElementById('active-preset-label').classList.add('hidden');
    activePresetLabel = '';
  });
});

// ============================================================
// Compare Frames
// ============================================================

let compareTarget = null;   // 'a' or 'b' ‚Äî which slot the preset modal is selecting for
let compareFrameA = null;   // { brand, model, size, stack, reach, sta, hta }
let compareFrameB = null;

function openComparePresetModal(target) {
  compareTarget = target;
  renderPresetModal();
  document.getElementById('preset-modal').classList.add('open');
  document.getElementById('preset-search').value = '';
  document.getElementById('preset-search').focus();
}

function renderCompareView() {
  drawComparisonDiagram(compareFrameA, compareFrameB);
  renderCompareTable(compareFrameA, compareFrameB);
}

function renderCompareTable(frameA, frameB) {
  const container = document.getElementById('compare-table');
  if (!frameA && !frameB) {
    container.innerHTML = '<p style="color:var(--text-dim);text-align:center;padding:20px;">Select two frames to compare geometry.</p>';
    return;
  }

  const metrics = [
    { key: 'stack', label: 'Stack', unit: 'mm' },
    { key: 'reach', label: 'Reach', unit: 'mm' },
    { key: 'sta',   label: 'Seat Tube Angle', unit: '\u00B0' },
    { key: 'hta',   label: 'Head Tube Angle', unit: '\u00B0' },
  ];

  const rows = metrics.map(m => {
    const valA = frameA ? frameA[m.key] : null;
    const valB = frameB ? frameB[m.key] : null;
    const dispA = valA !== null ? valA + m.unit : '\u2014';
    const dispB = valB !== null ? valB + m.unit : '\u2014';
    let diff = '';
    if (valA !== null && valB !== null) {
      const d = Math.round((valB - valA) * 10) / 10;
      const sign = d > 0 ? '+' : '';
      diff = `${sign}${d}${m.unit}`;
    }
    return `<tr>
      <td class="compare-metric">${m.label}</td>
      <td class="compare-val-a">${dispA}</td>
      <td class="compare-val-b">${dispB}</td>
      <td class="compare-diff">${diff}</td>
    </tr>`;
  }).join('');

  const labelA = frameA ? `${frameA.brand} ${frameA.model} ${frameA.size}` : 'Frame A';
  const labelB = frameB ? `${frameB.brand} ${frameB.model} ${frameB.size}` : 'Frame B';

  container.innerHTML = `
    <table class="compare-table">
      <thead>
        <tr>
          <th></th>
          <th style="color:var(--accent)">${labelA}</th>
          <th style="color:var(--green)">${labelB}</th>
          <th>Difference</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}

function drawComparisonDiagram(frameA, frameB) {
  const svg = document.getElementById('compare-svg');
  const W = 800, H = 500;
  const cs = getComputedStyle(document.documentElement);
  const colGrid = cs.getPropertyValue('--svg-grid').trim();
  const colFrame = cs.getPropertyValue('--svg-frame').trim();
  const colDimSubtle = cs.getPropertyValue('--svg-dim-subtle').trim();
  const colTextSubtle = cs.getPropertyValue('--svg-text-subtle').trim();
  const colGround = cs.getPropertyValue('--svg-ground').trim();
  const colBBLabel = cs.getPropertyValue('--svg-bb-label').trim();
  const colAccent = cs.getPropertyValue('--accent').trim();
  const colGreen = cs.getPropertyValue('--green').trim();
  const isLight = document.documentElement.classList.contains('light');
  const colBBStroke = isLight ? '#333' : '#fff';

  const scale = 0.55;
  const originX = 280, originY = 420;
  function tx(x) { return originX + x * scale; }
  function ty(y) { return originY - y * scale; }

  let html = `<rect width="${W}" height="${H}" fill="${isLight ? '#f8f9fa' : '#0f0f1a'}" rx="8"/>`;

  // Grid
  for (let gx = 0; gx < W; gx += 40) html += `<line x1="${gx}" y1="0" x2="${gx}" y2="${H}" stroke="${colGrid}" stroke-width="0.5"/>`;
  for (let gy = 0; gy < H; gy += 40) html += `<line x1="0" y1="${gy}" x2="${W}" y2="${gy}" stroke="${colGrid}" stroke-width="0.5"/>`;

  // BB point
  html += `<circle cx="${tx(0)}" cy="${ty(0)}" r="6" fill="${colAccent}" stroke="${colBBStroke}" stroke-width="1.5"/>`;
  html += `<text x="${tx(0)}" y="${ty(0) + 18}" fill="${colBBLabel}" font-size="10" text-anchor="middle" font-weight="600">BB</text>`;

  // Ground line
  html += `<line x1="40" y1="${ty(0)}" x2="${W - 40}" y2="${ty(0)}" stroke="${colGround}" stroke-width="1" stroke-dasharray="6 4"/>`;

  // Draw each frame
  if (frameA) html += drawFrameOverlay(frameA, colAccent, 'A', tx, ty, colTextSubtle, colDimSubtle, 0);
  if (frameB) html += drawFrameOverlay(frameB, colGreen, 'B', tx, ty, colTextSubtle, colDimSubtle, 1);

  // If no frames selected, show hint
  if (!frameA && !frameB) {
    html += `<text x="${W / 2}" y="${H / 2}" fill="${colTextSubtle}" font-size="14" text-anchor="middle">Select frames above to see the comparison</text>`;
  }

  svg.innerHTML = html;
}

function drawFrameOverlay(frame, color, label, tx, ty, colTextSubtle, colDimSubtle, index) {
  let html = '';
  const staRad = rad(frame.sta);
  const htaRad = rad(frame.hta);

  const bbX = tx(0), bbY = ty(0);

  // Head tube top (stack/reach position)
  const htTopX = tx(frame.reach);
  const htTopY = ty(frame.stack);

  // Head tube bottom (150mm along HTA from top)
  const htLen = 150;
  const htBotX = tx(frame.reach + htLen * Math.cos(htaRad));
  const htBotY = ty(frame.stack - htLen * Math.sin(htaRad));

  // Seat tube ‚Äî extend upward from BB at STA, find the point at the same height as head tube top
  const seatTopY = frame.stack * 1.05; // extend slightly above head tube top for visual
  const seatTopX = -(seatTopY / Math.tan(staRad));

  // Top tube ‚Äî from seat tube at head-tube-top height to head tube top
  const ttSeatX = -(frame.stack / Math.tan(staRad));

  // Seat tube line (from BB upward)
  html += `<line x1="${bbX}" y1="${bbY}" x2="${tx(seatTopX)}" y2="${ty(seatTopY)}" stroke="${color}" stroke-width="2.5" opacity="0.85"/>`;

  // Head tube
  html += `<line x1="${htBotX}" y1="${htBotY}" x2="${htTopX}" y2="${htTopY}" stroke="${color}" stroke-width="2.5" opacity="0.85"/>`;

  // Top tube (virtual ‚Äî seat tube at stack height to head tube top)
  html += `<line x1="${tx(ttSeatX)}" y1="${htTopY}" x2="${htTopX}" y2="${htTopY}" stroke="${color}" stroke-width="2" opacity="0.7"/>`;

  // Down tube (BB to head tube bottom)
  html += `<line x1="${bbX}" y1="${bbY}" x2="${htBotX}" y2="${htBotY}" stroke="${color}" stroke-width="2" opacity="0.7"/>`;

  // Label at head tube top
  const labelOffsetX = index === 0 ? -8 : 8;
  const labelAnchor = index === 0 ? 'end' : 'start';
  html += `<text x="${htTopX + labelOffsetX}" y="${htTopY - 8}" fill="${color}" font-size="11" font-weight="700" text-anchor="${labelAnchor}">${label}</text>`;

  // Stack dimension line (subtle, offset to avoid overlap)
  const dimOffsetX = index === 0 ? -25 : 15;
  const sx = tx(0) + dimOffsetX;
  html += `<line x1="${sx}" y1="${ty(0)}" x2="${sx}" y2="${ty(frame.stack)}" stroke="${color}" stroke-width="1" stroke-dasharray="3 3" opacity="0.5"/>`;
  html += `<text x="${sx - 3}" y="${ty(frame.stack / 2)}" fill="${color}" font-size="9" text-anchor="end" opacity="0.7" transform="rotate(-90,${sx - 3},${ty(frame.stack / 2)})">${frame.stack}mm</text>`;

  // Reach dimension line (subtle, offset to avoid overlap)
  const dimOffsetY = index === 0 ? 15 : 28;
  const ry = ty(frame.stack) - dimOffsetY;
  html += `<line x1="${tx(0)}" y1="${ry}" x2="${tx(frame.reach)}" y2="${ry}" stroke="${color}" stroke-width="1" stroke-dasharray="3 3" opacity="0.5"/>`;
  html += `<text x="${tx(frame.reach / 2)}" y="${ry - 3}" fill="${color}" font-size="9" text-anchor="middle" opacity="0.7">${frame.reach}mm</text>`;

  return html;
}

// ============================================================
// Calculation Engine
// ============================================================

function deg(rad) { return rad * 180 / Math.PI; }
function rad(deg) { return deg * Math.PI / 180; }

function calcSaddlePosition(saddleHeight, sta, saddleSetback) {
  const staRad = rad(sta);
  // Saddle position along seat tube, then setback
  // Seat tube goes up and backward from BB at STA from horizontal
  const saddleX = -(saddleHeight * Math.cos(staRad)) - saddleSetback;
  const saddleY = saddleHeight * Math.sin(staRad);
  return { x: saddleX, y: saddleY };
}

function calcHoodPosition(frameReach, frameStack, hta, spacerStack, stemLength, stemAngle, barReach, stemHeight, barDiameter) {
  stemHeight = stemHeight || 0;
  barDiameter = barDiameter || 0;
  const htaRad = rad(hta);

  // Total steerer travel = spacers + half stem height (measurements from stem centre)
  const totalSteerer = spacerStack + stemHeight / 2;

  // Stem base along steerer from top of head tube
  const stemBaseX = frameReach + totalSteerer * (-Math.cos(htaRad));
  const stemBaseY = frameStack + totalSteerer * Math.sin(htaRad);

  // Stem angle from horizontal
  // stem_angle is relative to steerer perpendicular (0 = perpendicular to steerer)
  // Effective angle from horizontal = (90 - HTA) + stemAngle
  const stemAngleHoriz = rad(90 - hta + stemAngle);

  const stemEndX = stemBaseX + stemLength * Math.cos(stemAngleHoriz);
  const stemEndY = stemBaseY + stemLength * Math.sin(stemAngleHoriz);

  // Handlebar reach is horizontal forward from stem clamp
  // Handlebar radius (half diameter) adds to the hood height (hoods sit on top of the bar)
  const hoodX = stemEndX + barReach;
  const hoodY = stemEndY + barDiameter / 2;

  return {
    stemBase: { x: stemBaseX, y: stemBaseY },
    stemEnd: { x: stemEndX, y: stemEndY },
    hood: { x: hoodX, y: hoodY }
  };
}

function forwardCalc(params) {
  const saddle = calcSaddlePosition(params.saddleHeight, params.sta, params.saddleSetback);
  const hood = calcHoodPosition(
    params.reach, params.stack, params.hta,
    params.spacerStack, params.stemLength, params.stemAngle, params.barReach,
    params.stemHeight, params.barDiameter
  );

  const saddleToHoodReach = hood.hood.x - saddle.x;
  const saddleToHoodDrop = saddle.y - hood.hood.y; // positive = hoods lower than saddle
  const saddleToHoodDist = Math.sqrt(saddleToHoodReach ** 2 + saddleToHoodDrop ** 2);

  // Handlebar position: same Y as hood (bar radius above center) but no barReach
  const handlebar = { x: hood.stemEnd.x, y: hood.stemEnd.y + (params.barDiameter || 0) / 2 };

  // Active measurement point based on toggle
  const mp = measureTarget === 'bars' ? handlebar : hood.hood;
  const saddleToMeasureReach = mp.x - saddle.x;
  const saddleToMeasureDrop = saddle.y - mp.y;
  const saddleToMeasureDist = Math.sqrt(saddleToMeasureReach ** 2 + saddleToMeasureDrop ** 2);
  const measureHeight = mp.y;
  const measureReachFromBB = mp.x;

  // Effective saddle height (vertical from BB)
  const saddleVertical = saddle.y;

  // Hood height above BB
  const hoodHeight = hood.hood.y;

  // Hood reach from BB (horizontal distance from BB to hoods)
  const hoodReachFromBB = hood.hood.x;

  // Saddle to bar reach (horizontal distance from saddle to stem/bar junction)
  const saddleToBarReach = hood.stemEnd.x - saddle.x;

  // Effective seat tube angle (actual angle from BB to saddle, accounting for setback)
  const effectiveSTA = deg(Math.atan2(saddle.y, -saddle.x));

  // Saddle to BB horizontal setback (how far the saddle is behind the BB)
  const saddleBBSetback = -saddle.x;

  return {
    saddle,
    hood: hood.hood,
    handlebar,
    measurePoint: mp,
    stemBase: hood.stemBase,
    stemEnd: hood.stemEnd,
    saddleToHoodReach,
    saddleToHoodDrop,
    saddleToHoodDist,
    saddleToMeasureReach,
    saddleToMeasureDrop,
    saddleToMeasureDist,
    measureHeight,
    measureReachFromBB,
    saddleVertical,
    hoodHeight,
    hoodReachFromBB,
    saddleToBarReach,
    effectiveSTA,
    saddleBBSetback
  };
}

function reverseSolve(params) {
  // Solve for unknown components given fit targets
  const saddle = calcSaddlePosition(params.saddleHeight, params.sta, params.saddleSetback);

  // Target hood position
  const targetHoodX = saddle.x + params.targetReach;
  const targetHoodY = saddle.y - params.targetDrop;

  const htaRad = rad(params.hta);
  const stemHeight = params.stemHeight || 0;
  const barDiameter = params.barDiameter || 0;

  // The hood position includes bar radius (half diameter) vertically above the stem end,
  // and the steerer travel is spacerStack + stemHeight/2 (centre of stem clamp).
  // So we solve for T = spacerStack + stemHeight/2 (total steerer travel),
  // then spacerStack = T - stemHeight/2.
  // The stem end Y needs to be: targetHoodY - barDiameter/2
  // Effective target for stem end:
  const effTargetHoodY = targetHoodY - barDiameter / 2;

  if (params.fixVar === 'stem-angle') {
    // Known: stem angle, solve for total steerer (T) and stem length (L)
    const stemAngleHoriz = rad(90 - params.hta + params.fixStemAngle);
    const cosA = Math.cos(stemAngleHoriz);
    const sinA = Math.sin(stemAngleHoriz);

    // targetHoodX = reach + T*(-cos(HTA)) + L*cos(Œ∏) + barReach
    // effTargetHoodY = stack + T*sin(HTA) + L*sin(Œ∏)
    const rhs1 = targetHoodX - params.reach - params.barReach;
    const rhs2 = effTargetHoodY - params.stack;

    const det = cosA * Math.sin(htaRad) - sinA * (-Math.cos(htaRad));
    if (Math.abs(det) < 0.001) {
      return { error: 'No solution (degenerate angle combination)' };
    }

    const stemLength = (rhs1 * Math.sin(htaRad) - rhs2 * (-Math.cos(htaRad))) / det;
    const T = (cosA * rhs2 - sinA * rhs1) / det;
    const spacerStack = T - stemHeight / 2;

    return {
      stemLength: Math.round(stemLength * 10) / 10,
      spacerStack: Math.round(spacerStack * 10) / 10,
      stemAngle: params.fixStemAngle,
      saddle, targetHoodX, targetHoodY
    };

  } else if (params.fixVar === 'spacers') {
    // Known: spacers, solve for stem length (L) and stem angle (Œ∏)
    const S = params.fixSpacers;
    const T = S + stemHeight / 2;
    const baseX = params.reach + T * (-Math.cos(htaRad));
    const baseY = params.stack + T * Math.sin(htaRad);

    const dx = targetHoodX - baseX - params.barReach;
    const dy = effTargetHoodY - baseY;

    const stemLength = Math.sqrt(dx * dx + dy * dy);
    const stemAngleHoriz = Math.atan2(dy, dx);
    const stemAngle = deg(stemAngleHoriz) - (90 - params.hta);

    return {
      stemLength: Math.round(stemLength * 10) / 10,
      spacerStack: S,
      stemAngle: Math.round(stemAngle * 10) / 10,
      saddle, targetHoodX, targetHoodY
    };

  } else if (params.fixVar === 'stem-length') {
    // Known: stem length, solve for total steerer (T) and stem angle
    const L = params.fixStemLength;
    const A = targetHoodX - params.reach - params.barReach;
    const B = effTargetHoodY - params.stack;
    const cx = -Math.cos(htaRad);
    const cy = Math.sin(htaRad);

    // (A - T*cx)^2 + (B - T*cy)^2 = L^2
    const a = 1;
    const b = -2 * (A * cx + B * cy);
    const c = A * A + B * B - L * L;

    const disc = b * b - 4 * a * c;
    if (disc < 0) {
      return { error: 'No solution (stem too short to reach target)' };
    }

    const t1 = (-b + Math.sqrt(disc)) / (2 * a);
    const t2 = (-b - Math.sqrt(disc)) / (2 * a);

    // Convert T to spacerStack = T - stemHeight/2, pick valid (spacerStack >= 0)
    const sp1 = t1 - stemHeight / 2;
    const sp2 = t2 - stemHeight / 2;

    let T, spacerStack;
    if (sp1 >= 0 && sp2 >= 0) { spacerStack = Math.min(sp1, sp2); T = spacerStack + stemHeight / 2; }
    else if (sp1 >= 0) { spacerStack = sp1; T = t1; }
    else if (sp2 >= 0) { spacerStack = sp2; T = t2; }
    else return { error: 'No valid solution (negative spacers required)' };

    const baseX = params.reach + T * cx;
    const baseY = params.stack + T * cy;
    const dx = targetHoodX - baseX - params.barReach;
    const dy = effTargetHoodY - baseY;
    const stemAngleHoriz = Math.atan2(dy, dx);
    const stemAngle = deg(stemAngleHoriz) - (90 - params.hta);

    return {
      stemLength: L,
      spacerStack: Math.round(spacerStack * 10) / 10,
      stemAngle: Math.round(stemAngle * 10) / 10,
      saddle, targetHoodX, targetHoodY
    };
  }
}


// ============================================================
// SVG Diagram Renderer
// ============================================================

function drawBikeDiagram(params, results) {
  const svg = document.getElementById('bike-svg');
  const W = 800, H = 500;

  // Read current theme colors from CSS variables
  const cs = getComputedStyle(document.documentElement);
  const colGrid = cs.getPropertyValue('--svg-grid').trim();
  const colFrame = cs.getPropertyValue('--svg-frame').trim();
  const colDimSubtle = cs.getPropertyValue('--svg-dim-subtle').trim();
  const colTextSubtle = cs.getPropertyValue('--svg-text-subtle').trim();
  const colGround = cs.getPropertyValue('--svg-ground').trim();
  const colBBLabel = cs.getPropertyValue('--svg-bb-label').trim();
  const colAccent = cs.getPropertyValue('--accent').trim();
  const colGreen = cs.getPropertyValue('--green').trim();
  const colYellow = '#f0c040';
  const isLight = document.documentElement.classList.contains('light');
  const colBBStroke = isLight ? '#333' : '#fff';
  const colSaddleStroke = isLight ? '#333' : '#fff';
  const colHoodStroke = isLight ? '#333' : '#fff';

  // Transform: bike coords (origin BB, Y up) ‚Üí SVG (origin top-left, Y down)
  const scale = 0.55;
  const originX = 280;
  const originY = 420;

  function tx(x) { return originX + x * scale; }
  function ty(y) { return originY - y * scale; }

  let html = '';

  // Background grid (subtle)
  for (let gx = 0; gx < W; gx += 40) {
    html += `<line x1="${gx}" y1="0" x2="${gx}" y2="${H}" stroke="${colGrid}" stroke-width="0.5"/>`;
  }
  for (let gy = 0; gy < H; gy += 40) {
    html += `<line x1="0" y1="${gy}" x2="${W}" y2="${gy}" stroke="${colGrid}" stroke-width="0.5"/>`;
  }

  // BB point
  const bbX = tx(0), bbY = ty(0);
  html += `<circle cx="${bbX}" cy="${bbY}" r="6" fill="${colAccent}" stroke="${colBBStroke}" stroke-width="1.5"/>`;
  html += `<text x="${bbX}" y="${bbY + 18}" fill="${colBBLabel}" font-size="10" text-anchor="middle">BB</text>`;

  // Ground line
  html += `<line x1="20" y1="${ty(0)}" x2="${W - 20}" y2="${ty(0)}" stroke="${colGround}" stroke-width="1" stroke-dasharray="4,4"/>`;

  // Seat tube line (from BB upward at STA)
  const staRad = rad(params.sta);
  const seatTubeLen = params.saddleHeight || 740;
  const stTopX = tx(-(seatTubeLen * Math.cos(staRad)));
  const stTopY = ty(seatTubeLen * Math.sin(staRad));
  html += `<line x1="${bbX}" y1="${bbY}" x2="${stTopX}" y2="${stTopY}" stroke="${colFrame}" stroke-width="2.5"/>`;

  // Saddle
  const saddle = results.saddle;
  const saddleX = tx(saddle.x), saddleY = ty(saddle.y);
  html += `<rect x="${saddleX - 20}" y="${saddleY - 3}" width="40" height="6" rx="3" fill="${colAccent}" stroke="${colSaddleStroke}" stroke-width="1"/>`;
  html += `<text x="${saddleX}" y="${saddleY - 10}" fill="${colAccent}" font-size="10" text-anchor="middle" font-weight="600">Saddle</text>`;

  // Head tube
  const htaRad = rad(params.hta);
  const htTopX = tx(params.reach);
  const htTopY = ty(params.stack);
  const htLen = 150;
  const htBotX = tx(params.reach + htLen * Math.cos(htaRad));
  const htBotY = ty(params.stack - htLen * Math.sin(htaRad));
  html += `<line x1="${htBotX}" y1="${htBotY}" x2="${htTopX}" y2="${htTopY}" stroke="${colFrame}" stroke-width="2.5"/>`;

  // Top tube
  const virtualSeatTopX = tx(-(params.stack / Math.tan(staRad)));
  const virtualSeatTopY = ty(params.stack * 0.95);
  html += `<line x1="${virtualSeatTopX}" y1="${virtualSeatTopY}" x2="${htTopX}" y2="${htTopY}" stroke="${colFrame}" stroke-width="2"/>`;

  // Down tube (BB to near head tube bottom)
  html += `<line x1="${bbX}" y1="${bbY}" x2="${htBotX}" y2="${htBotY}" stroke="${colFrame}" stroke-width="2"/>`;

  // Spacers on steerer (from head tube top upward)
  if (results.stemBase) {
    const stemBaseX = tx(results.stemBase.x);
    const stemBaseY = ty(results.stemBase.y);
    html += `<line x1="${htTopX}" y1="${htTopY}" x2="${stemBaseX}" y2="${stemBaseY}" stroke="${colGreen}" stroke-width="4" stroke-linecap="round"/>`;
  }

  // Stem
  if (results.stemBase && results.stemEnd) {
    const sbx = tx(results.stemBase.x), sby = ty(results.stemBase.y);
    const sex = tx(results.stemEnd.x), sey = ty(results.stemEnd.y);
    html += `<line x1="${sbx}" y1="${sby}" x2="${sex}" y2="${sey}" stroke="${colYellow}" stroke-width="3" stroke-linecap="round"/>`;
    html += `<text x="${(sbx + sex) / 2}" y="${(sby + sey) / 2 - 8}" fill="${colYellow}" font-size="10" text-anchor="middle" font-weight="600">Stem</text>`;
  }

  // Handlebar (stem end to hood) ‚Äî always draw the physical bar line
  if (results.stemEnd && results.hood) {
    const sex = tx(results.stemEnd.x), sey = ty(results.stemEnd.y);
    const hx = tx(results.hood.x), hy = ty(results.hood.y);
    html += `<line x1="${sex}" y1="${sey}" x2="${hx}" y2="${hy}" stroke="${colGreen}" stroke-width="2.5" stroke-linecap="round"/>`;

    // Green dot: hoods position when measuring to hoods, stem/bar junction when measuring to handlebars
    const isHoods = measureTarget === 'hoods';
    const dotPos = isHoods ? results.hood : results.stemEnd;
    const dotX = tx(dotPos.x), dotY = ty(dotPos.y);
    const mpLabel = isHoods ? 'Hoods' : 'Bars';
    html += `<circle cx="${dotX}" cy="${dotY}" r="5" fill="${colGreen}" stroke="${colHoodStroke}" stroke-width="1"/>`;
    html += `<text x="${dotX + 8}" y="${dotY - 8}" fill="${colGreen}" font-size="10" font-weight="600">${mpLabel}</text>`;
  }

  // Dimension: Saddle to measurement point Reach (horizontal)
  if (results.measurePoint && saddle) {
    const mpx = tx(results.measurePoint.x), mpy = ty(results.measurePoint.y);
    const dimY = Math.max(saddleY, mpy) + 40;
    html += `<line x1="${saddleX}" y1="${dimY - 5}" x2="${saddleX}" y2="${dimY + 5}" stroke="${colAccent}" stroke-width="1"/>`;
    html += `<line x1="${mpx}" y1="${dimY - 5}" x2="${mpx}" y2="${dimY + 5}" stroke="${colAccent}" stroke-width="1"/>`;
    html += `<line x1="${saddleX}" y1="${dimY}" x2="${mpx}" y2="${dimY}" stroke="${colAccent}" stroke-width="1" stroke-dasharray="3,3"/>`;
    const reachLabel = Math.round(results.saddleToMeasureReach) + 'mm reach';
    html += `<text x="${(saddleX + mpx) / 2}" y="${dimY + 14}" fill="${colAccent}" font-size="10" text-anchor="middle" font-weight="600">${reachLabel}</text>`;
  }

  // Dimension: Saddle to measurement point Drop (vertical)
  if (results.measurePoint && saddle) {
    const mpx = tx(results.measurePoint.x), mpy = ty(results.measurePoint.y);
    const dimX = Math.min(saddleX, mpx) - 30;
    html += `<line x1="${dimX - 5}" y1="${saddleY}" x2="${dimX + 5}" y2="${saddleY}" stroke="${colGreen}" stroke-width="1"/>`;
    html += `<line x1="${dimX - 5}" y1="${mpy}" x2="${dimX + 5}" y2="${mpy}" stroke="${colGreen}" stroke-width="1"/>`;
    html += `<line x1="${dimX}" y1="${saddleY}" x2="${dimX}" y2="${mpy}" stroke="${colGreen}" stroke-width="1" stroke-dasharray="3,3"/>`;
    const dropLabel = Math.round(results.saddleToMeasureDrop) + 'mm drop';
    html += `<text x="${dimX - 5}" y="${(saddleY + mpy) / 2}" fill="${colGreen}" font-size="10" text-anchor="end" font-weight="600">${dropLabel}</text>`;
  }

  // Stack and Reach dimension lines (subtle)
  const stackTopX = tx(0), stackTopY = ty(params.stack);
  const reachEndX = tx(params.reach), reachEndY = ty(0);
  html += `<line x1="${bbX}" y1="${bbY - 2}" x2="${reachEndX}" y2="${bbY - 2}" stroke="${colDimSubtle}" stroke-width="0.8" stroke-dasharray="2,3"/>`;
  html += `<text x="${(bbX + reachEndX) / 2}" y="${bbY + 30}" fill="${colTextSubtle}" font-size="9" text-anchor="middle">Reach ${params.reach}mm</text>`;
  html += `<line x1="${reachEndX + 2}" y1="${bbY}" x2="${reachEndX + 2}" y2="${htTopY}" stroke="${colDimSubtle}" stroke-width="0.8" stroke-dasharray="2,3"/>`;
  html += `<text x="${reachEndX + 12}" y="${(bbY + htTopY) / 2}" fill="${colTextSubtle}" font-size="9" font-weight="400">Stack ${params.stack}mm</text>`;

  svg.innerHTML = html;
}


// ============================================================
// UI Controller
// ============================================================

let currentMode = 'forward';
let measureTarget = 'hoods'; // 'hoods' or 'bars'

function setMeasureTarget(target) {
  measureTarget = target;
  document.querySelectorAll('.measure-toggle button').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.target === target);
  });
  updateTargetLabels();
  if (currentMode === 'compare') renderCompareView();
  else recalculate();
}

function updateTargetLabels() {
  const reachLabel = document.getElementById('label-target-reach');
  const dropLabel = document.getElementById('label-target-drop');
  if (measureTarget === 'bars') {
    reachLabel.textContent = 'Target Saddle-to-Handlebar Reach';
    dropLabel.textContent = 'Target Saddle-to-Handlebar Drop';
  } else {
    reachLabel.textContent = 'Target Saddle-to-Hood Reach';
    dropLabel.textContent = 'Target Saddle-to-Hood Drop';
  }
}

function setMode(mode) {
  currentMode = mode;
  const isCompare = mode === 'compare';

  document.getElementById('mode-forward').classList.toggle('active', mode === 'forward');
  document.getElementById('mode-reverse').classList.toggle('active', mode === 'reverse');

  // Hide/show calculator vs compare views
  document.querySelectorAll('.calculator-view').forEach(el => el.classList.toggle('hidden', isCompare));
  document.getElementById('compare-view').classList.toggle('hidden', !isCompare);

  if (isCompare) {
    renderCompareView();
  } else {
    document.getElementById('card-components').classList.toggle('hidden', mode === 'reverse');
    document.getElementById('card-targets').classList.toggle('hidden', mode === 'forward');
    document.getElementById('card-results').classList.toggle('hidden', mode === 'reverse');
    updateConstraintVisibility();
    recalculate();
  }
}

function updateConstraintVisibility() {
  const fixVar = document.getElementById('constraint-var').value;
  document.getElementById('fix-stem-angle-group').classList.toggle('hidden', fixVar !== 'stem-angle');
  document.getElementById('fix-spacers-group').classList.toggle('hidden', fixVar !== 'spacers');
  document.getElementById('fix-stem-length-group').classList.toggle('hidden', fixVar !== 'stem-length');
}

function getVal(id) {
  return parseFloat(document.getElementById(id).value) || 0;
}

function recalculate() {
  const frameParams = {
    stack: getVal('stack'),
    reach: getVal('reach'),
    sta: getVal('sta'),
    hta: getVal('hta')
  };

  if (currentMode === 'forward') {
    const params = {
      ...frameParams,
      stemLength: getVal('stem-length'),
      stemAngle: getVal('stem-angle'),
      spacerStack: getVal('spacer-stack'),
      stemHeight: getVal('stem-height'),
      barReach: getVal('bar-reach'),
      barDiameter: getVal('bar-diameter'),
      saddleHeight: getVal('saddle-height'),
      saddleSetback: getVal('saddle-setback')
    };

    const results = forwardCalc(params);
    renderForwardResults(results);
    const bbDisplay = document.getElementById('bb-setback-display');
    if (bbDisplay) {
      const tip = bbDisplay.querySelector('.tip-text');
      const tipHtml = tip ? tip.outerHTML : '';
      bbDisplay.innerHTML = '‚Ü≥ ' + (Math.round(results.saddleBBSetback * 10) / 10) + 'mm behind BB ‚ìò' + tipHtml;
    }
    drawBikeDiagram(params, results);

  } else {
    const fixVar = document.getElementById('constraint-var').value;
    const params = {
      ...frameParams,
      saddleHeight: getVal('target-saddle-height'),
      saddleSetback: getVal('target-saddle-setback'),
      barReach: measureTarget === 'bars' ? 0 : getVal('target-bar-reach'),
      stemHeight: getVal('target-stem-height'),
      barDiameter: getVal('target-bar-diameter'),
      targetReach: getVal('target-reach'),
      targetDrop: getVal('target-drop'),
      fixVar
    };

    if (fixVar === 'stem-angle') params.fixStemAngle = getVal('fix-stem-angle');
    else if (fixVar === 'spacers') params.fixSpacers = getVal('fix-spacers');
    else if (fixVar === 'stem-length') params.fixStemLength = getVal('fix-stem-length');

    const result = reverseSolve(params);
    renderReverseResults(result);

    // Also draw the diagram with the solved values
    if (!result.error) {
      const fwdParams = {
        ...frameParams,
        stemLength: result.stemLength,
        stemAngle: result.stemAngle,
        spacerStack: result.spacerStack,
        stemHeight: params.stemHeight,
        barReach: getVal('target-bar-reach'), // always real barReach for forward calc
        barDiameter: params.barDiameter,
        saddleHeight: params.saddleHeight,
        saddleSetback: params.saddleSetback
      };
      const fwdResults = forwardCalc(fwdParams);
      drawBikeDiagram(fwdParams, fwdResults);
      const bbDisplayRev = document.getElementById('bb-setback-display-reverse');
      if (bbDisplayRev) {
        const tip = bbDisplayRev.querySelector('.tip-text');
        const tipHtml = tip ? tip.outerHTML : '';
        bbDisplayRev.innerHTML = '‚Ü≥ ' + (Math.round(fwdResults.saddleBBSetback * 10) / 10) + 'mm behind BB ‚ìò' + tipHtml;
      }
    }
  }
}

function renderForwardResults(r) {
  const container = document.getElementById('forward-results');
  const isHoods = measureTarget === 'hoods';
  const ptName = isHoods ? 'Hood' : 'Handlebar';
  const ptDesc = isHoods ? 'brake hoods' : 'handlebar (top of bar at stem clamp)';

  const items = [
    { label: `Saddle \u2192 ${ptName} Reach`, value: r.saddleToMeasureReach, unit: 'mm', highlight: true, tooltip: `Horizontal distance from the saddle BRP to the ${ptDesc}. The primary measurement for how stretched out your position is.` },
    { label: `Saddle \u2192 ${ptName} Drop`, value: r.saddleToMeasureDrop, unit: 'mm', highlight: true, tooltip: `Vertical drop from the saddle BRP to the ${ptDesc}. Positive means ${isHoods ? 'hoods are' : 'bars are'} lower than saddle. More drop = more aggressive.` },
  ];

  items.push(
    { label: 'Effective Seat Tube Angle', value: r.effectiveSTA, unit: '\u00B0', tooltip: 'Actual angle from the BB centre to the saddle BRP, accounting for any saddle setback. May differ from the frame seat tube angle.' },
    { label: 'Saddle Height (vertical)', value: r.saddleVertical, unit: 'mm', tooltip: 'True vertical height of the saddle BRP above the bottom bracket centre. Slightly less than the along-tube saddle height measurement.' },
    { label: `${ptName} Height above BB`, value: r.measureHeight, unit: 'mm', tooltip: `Vertical height of the ${ptDesc} above the bottom bracket centre. Determined by frame stack, spacers, stem, and bar.` },
    { label: `${ptName} Reach from BB`, value: r.measureReachFromBB, unit: 'mm', tooltip: `Horizontal distance from the BB centre to the ${ptDesc}. Shows how far forward the ${isHoods ? 'hoods are' : 'bars are'} from the BB.` }
  );

  container.innerHTML = items.map(item => {
    const val = Math.round(item.value * 10) / 10;
    const cls = item.highlight ? ' highlight' : '';
    const tip = item.tooltip ? ` <span class="label-tip">&#9432;<span class="tip-text">${item.tooltip}</span></span>` : '';
    return `
      <div class="result-item${cls}">
        <div class="result-label">${item.label}${tip}</div>
        <div class="result-value">${val}</div>
        <div class="result-unit">${item.unit}</div>
      </div>
    `;
  }).join('');

  // Spacer stack warning in forward mode
  const spacerStack = getVal('spacer-stack');
  const fwdNote = document.getElementById('forward-note');
  if (spacerStack > 40) {
    fwdNote.textContent = 'Spacer stack is very high (' + spacerStack + 'mm). Consider a larger frame with more stack to reduce the need for spacers.';
  } else {
    fwdNote.textContent = '';
  }
}

function renderReverseResults(result) {
  const container = document.getElementById('reverse-results');
  const note = document.getElementById('reverse-note');

  if (result.error) {
    container.innerHTML = `<div class="reverse-result rr-bad" style="grid-column:1/-1;"><div class="rr-label">Error</div><div class="rr-value" style="font-size:1rem;">${result.error}</div></div>`;
    note.textContent = '';
    return;
  }

  const items = [];

  const fixVar = document.getElementById('constraint-var').value;

  if (fixVar === 'stem-angle') {
    items.push({ label: 'Required Stem Length', value: result.stemLength, unit: 'mm', warn: result.stemLength < 60 || result.stemLength > 140 });
    items.push({ label: 'Required Spacer Stack', value: result.spacerStack, unit: 'mm', warn: result.spacerStack < 0 || result.spacerStack > 40 });
    items.push({ label: 'Stem Angle (fixed)', value: result.stemAngle, unit: '¬∞' });
  } else if (fixVar === 'spacers') {
    items.push({ label: 'Required Stem Length', value: result.stemLength, unit: 'mm', warn: result.stemLength < 60 || result.stemLength > 140 });
    items.push({ label: 'Required Stem Angle', value: result.stemAngle, unit: '¬∞', warn: result.stemAngle < -17 || result.stemAngle > 10 });
    items.push({ label: 'Spacer Stack (fixed)', value: result.spacerStack, unit: 'mm' });
  } else {
    items.push({ label: 'Required Spacer Stack', value: result.spacerStack, unit: 'mm', warn: result.spacerStack < 0 || result.spacerStack > 40 });
    items.push({ label: 'Required Stem Angle', value: result.stemAngle, unit: '¬∞', warn: result.stemAngle < -17 || result.stemAngle > 10 });
    items.push({ label: 'Stem Length (fixed)', value: result.stemLength, unit: 'mm' });
  }

  container.innerHTML = items.map(item => {
    const val = Math.round(item.value * 10) / 10;
    const cls = item.warn ? ' rr-warn' : '';
    return `
      <div class="reverse-result${cls}">
        <div class="rr-label">${item.label}</div>
        <div class="rr-value">${val}<span class="rr-unit">${item.unit}</span></div>
      </div>
    `;
  }).join('');

  // Warnings
  const warnings = [];
  if (result.stemLength < 60) warnings.push('Stem length is very short ‚Äî may not be available.');
  if (result.stemLength > 140) warnings.push('Stem length is very long ‚Äî may not be available or may handle poorly.');
  if (result.spacerStack < 0) warnings.push('Negative spacers required ‚Äî this frame may not achieve your target position. Consider a frame with different stack/reach.');
  if (result.spacerStack > 40) warnings.push('Spacer stack is very high ‚Äî consider a larger frame with more stack to reduce the need for spacers.');
  if (result.stemAngle < -17) warnings.push('Stem angle is extreme ‚Äî may not be commercially available.');
  if (result.stemAngle > 10) warnings.push('Positive stem angle is unusual for road bikes ‚Äî double check targets.');

  note.textContent = warnings.join(' ');
}

// Wire up all inputs to recalculate on change
document.querySelectorAll('input[type="number"]').forEach(input => {
  input.addEventListener('input', recalculate);
});

document.getElementById('constraint-var').addEventListener('change', () => {
  updateConstraintVisibility();
  recalculate();
});

// Initial calculation
recalculate();
</script>

</body>
</html>
