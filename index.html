<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bike Fit Cockpit Calculator</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üö¥</text></svg>">
<link rel="stylesheet" href="styles.css">
</head>
<body>

<header>
  <h1><span>Bike Fit</span> Cockpit Calculator</h1>
  <div class="header-controls">
    <div class="mode-toggle">
      <button id="mode-forward" class="active" onclick="setMode('forward')">Components ‚Üí Fit</button>
      <button id="mode-reverse" onclick="setMode('reverse')">Fit Targets ‚Üí Components</button>
    </div>
    <button class="info-btn" onclick="document.getElementById('instructions-modal').classList.add('open')">Instructions</button>
    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle light/dark mode">
      <span class="theme-icon" id="theme-icon">‚òÄÔ∏è</span>
      <span id="theme-label">Light</span>
    </button>
  </div>
</header>

<main>
  <!-- Frame Geometry Card -->
  <div class="card calculator-view">
    <h2>Frame Geometry</h2>
    <div class="input-grid">
      <div class="input-group">
        <label>Stack <span class="unit">(mm)</span> <span class="label-tip">&#9432;<span class="tip-text">Vertical distance from the centre of the bottom bracket to the top of the head tube. A key measurement for determining handlebar height.</span></span></label>
        <input type="number" id="stack" value="570" step="1">
      </div>
      <div class="input-group">
        <label>Reach <span class="unit">(mm)</span> <span class="label-tip">&#9432;<span class="tip-text">Horizontal distance from the centre of the bottom bracket to the top of the head tube. The primary measurement for frame length and rider stretch.</span></span></label>
        <input type="number" id="reach" value="390" step="1">
      </div>
      <div class="input-group">
        <label>Seat Tube Angle <span class="unit">(¬∞)</span> <span class="label-tip">&#9432;<span class="tip-text">Angle of the seat tube relative to horizontal. Steeper angles (higher numbers) place the saddle further forward over the BB. Typically 72¬∞‚Äì75¬∞ for road bikes.</span></span></label>
        <input type="number" id="sta" value="73.5" step="0.1">
      </div>
      <div class="input-group">
        <label>Head Tube Angle <span class="unit">(¬∞)</span> <span class="label-tip">&#9432;<span class="tip-text">Angle of the head tube relative to horizontal. Affects steering feel and how spacers/stem translate into reach and stack changes. Typically 71¬∞‚Äì74¬∞ for road bikes.</span></span></label>
        <input type="number" id="hta" value="73" step="0.1">
      </div>
    </div>
    <div class="preset-trigger">
      <button class="preset-trigger-btn frame-action-btn" onclick="openPresetModal()">Preset Frame Sizes</button>
      <span class="preset-active-label hidden" id="active-preset-label"></span>
    </div>
    <div class="preset-trigger">
      <button class="preset-trigger-btn frame-action-btn compare-btn" onclick="setMode('compare')">Compare Frames</button>
    </div>
  </div>

  <!-- Mode: Forward ‚Äî Component Inputs -->
  <div class="card calculator-view" id="card-components">
    <h2>Components <span class="measure-toggle-wrapper"><span class="separator">&middot;</span> Measure to: <span class="measure-toggle"><button class="active" data-target="hoods" onclick="setMeasureTarget('hoods')">Hoods</button><button data-target="bars" onclick="setMeasureTarget('bars')">Handlebars</button></span></span></h2>
    <div class="input-grid">
      <div class="input-group">
        <label>Stem Length <span class="unit">(mm)</span> <span class="label-tip">&#9432;<span class="tip-text">Centre-to-centre length of the stem. Common road sizes are 80‚Äì130mm. Longer stems increase reach to the hoods.</span></span></label>
        <input type="number" id="stem-length" value="100" step="5">
      </div>
      <div class="input-group">
        <label>Stem Angle <span class="unit">(¬∞ from steerer)</span> <span class="label-tip">&#9432;<span class="tip-text">Angle of the stem relative to the steerer tube. Negative values (e.g. ‚àí6¬∞) angle the stem downward for a lower bar position. 0¬∞ is perpendicular to the steerer.</span></span></label>
        <input type="number" id="stem-angle" value="-6" step="1">
      </div>
      <div class="input-group">
        <label>Spacer Stack <span class="unit">(mm)</span> <span class="label-tip">&#9432;<span class="tip-text">Total height of headset spacers below the stem. Spacers raise the handlebar position. Measured along the steerer tube axis.</span></span></label>
        <input type="number" id="spacer-stack" value="20" step="5">
      </div>
      <div class="input-group">
        <label>Stem Height <span class="unit">(mm)</span> <span class="label-tip">&#9432;<span class="tip-text">Height of the stem clamp on the steerer tube. This adds to the spacer stack to determine where the stem extends from. Typically 35‚Äì45mm for standard stems.</span></span></label>
        <input type="number" id="stem-height" value="40" step="1">
      </div>
      <div class="input-group">
        <label>Handlebar Reach <span class="unit">(mm)</span> <span class="label-tip">&#9432;<span class="tip-text">Horizontal distance from the stem clamp to the brake hoods. Varies by handlebar model, typically 70‚Äì85mm for road bars.</span></span></label>
        <input type="number" id="bar-reach" value="80" step="1">
      </div>
      <div class="input-group">
        <label>Handlebar Diameter <span class="unit">(mm)</span> <span class="label-tip">&#9432;<span class="tip-text">Outer diameter of the handlebar at the clamp area. Half the diameter is added to the vertical height of the hoods/handlebar position, since the contact point sits on top of the bar rather than at its centre. Standard road bars are 31.8mm (oversized) or 26.0mm (legacy).</span></span></label>
        <input type="number" id="bar-diameter" value="31.8" step="0.1">
      </div>
      <div class="input-group">
        <label>Saddle Height <span class="unit">(mm, BB to saddle BRP)</span> <span class="label-tip">&#9432;<span class="tip-text">Distance from the centre of the bottom bracket to the saddle's Biomechanical Reference Point (BRP), measured along the seat tube. The BRP is the designed sit-bone contact point on the saddle ‚Äî typically marked by the manufacturer or approximated as the deepest point of the saddle's profile.</span></span></label>
        <input type="number" id="saddle-height" value="740" step="1">
      </div>
      <div class="input-group">
        <label>Saddle Setback <span class="unit">(mm, behind seatpost)</span> <span class="label-tip">&#9432;<span class="tip-text">Horizontal offset of the saddle BRP (Biomechanical Reference Point) behind the seatpost clamp. Most saddle rails allow 0‚Äì20mm of setback adjustment. The BRP is the designed sit-bone contact point on the saddle.</span></span></label>
        <input type="number" id="saddle-setback" value="5" step="1">
        <div class="inline-result" id="bb-setback-display"><span class="tip-text">Horizontal distance from the saddle BRP (Biomechanical Reference Point) to the bottom bracket centre. Measured along the seat tube line plus any saddle setback. Use this to set your saddle position relative to the BB (e.g. KOPS or behind-BB targets).</span></div>
      </div>
    </div>
  </div>

  <!-- Mode: Reverse ‚Äî Fit Targets + Known Components -->
  <div class="card calculator-view hidden" id="card-targets">
    <h2>Fit Targets <span class="measure-toggle-wrapper"><span class="separator">&middot;</span> Measure to: <span class="measure-toggle"><button class="active" data-target="hoods" onclick="setMeasureTarget('hoods')">Hoods</button><button data-target="bars" onclick="setMeasureTarget('bars')">Handlebars</button></span></span></h2>
    <div class="input-grid">
      <div class="input-group">
        <label><span id="label-target-reach">Target Saddle-to-Hood Reach</span> <span class="unit">(mm)</span> <span class="label-tip">&#9432;<span class="tip-text">Desired horizontal distance from the saddle BRP (Biomechanical Reference Point) to the brake hoods. This is the main measurement for how stretched out your riding position is.</span></span></label>
        <input type="number" id="target-reach" value="760" step="1">
      </div>
      <div class="input-group">
        <label><span id="label-target-drop">Target Saddle-to-Hood Drop</span> <span class="unit">(mm)</span> <span class="label-tip">&#9432;<span class="tip-text">Desired vertical drop from the saddle BRP to the brake hoods. Positive values mean the hoods are lower than the saddle. More drop = more aggressive position.</span></span></label>
        <input type="number" id="target-drop" value="50" step="1">
      </div>
      <div class="input-group">
        <label>Saddle Height <span class="unit">(mm, BB to saddle BRP)</span> <span class="label-tip">&#9432;<span class="tip-text">Distance from the centre of the bottom bracket to the saddle's Biomechanical Reference Point (BRP), measured along the seat tube. The BRP is the designed sit-bone contact point on the saddle.</span></span></label>
        <input type="number" id="target-saddle-height" value="740" step="1">
      </div>
      <div class="input-group">
        <label>Saddle Setback <span class="unit">(mm, behind seatpost)</span> <span class="label-tip">&#9432;<span class="tip-text">Horizontal offset of the saddle BRP (Biomechanical Reference Point) behind the seatpost clamp. Most saddle rails allow 0‚Äì20mm of setback adjustment.</span></span></label>
        <input type="number" id="target-saddle-setback" value="5" step="1">
        <div class="inline-result" id="bb-setback-display-reverse"><span class="tip-text">Horizontal distance from the saddle BRP (Biomechanical Reference Point) to the bottom bracket centre. Measured along the seat tube line plus any saddle setback. Use this to set your saddle position relative to the BB (e.g. KOPS or behind-BB targets).</span></div>
      </div>
      <div class="input-group">
        <label>Handlebar Reach <span class="unit">(mm)</span> <span class="label-tip">&#9432;<span class="tip-text">Horizontal distance from the stem clamp to the brake hoods. Varies by handlebar model, typically 70‚Äì85mm for road bars.</span></span></label>
        <input type="number" id="target-bar-reach" value="80" step="1">
      </div>
      <div class="input-group">
        <label>Stem Height <span class="unit">(mm)</span> <span class="label-tip">&#9432;<span class="tip-text">Height of the stem clamp on the steerer tube. This adds to the spacer stack to determine where the stem extends from. Typically 35‚Äì45mm for standard stems.</span></span></label>
        <input type="number" id="target-stem-height" value="40" step="1">
      </div>
      <div class="input-group">
        <label>Handlebar Diameter <span class="unit">(mm)</span> <span class="label-tip">&#9432;<span class="tip-text">Outer diameter of the handlebar at the clamp area. Half the diameter is added to the vertical height of the hoods/handlebar position, since the contact point sits on top of the bar rather than at its centre. Standard road bars are 31.8mm (oversized) or 26.0mm (legacy).</span></span></label>
        <input type="number" id="target-bar-diameter" value="31.8" step="0.1">
      </div>
    </div>

    <div class="constraint-section" style="margin-top: 16px;">
      <label>Fix one variable, solve for the other two:</label>
      <select id="constraint-var" onchange="recalculate()">
        <option value="stem-angle">Fix Stem Angle ‚Äî solve for Stem Length &amp; Spacers</option>
        <option value="spacers">Fix Spacer Stack ‚Äî solve for Stem Length &amp; Angle</option>
        <option value="stem-length">Fix Stem Length ‚Äî solve for Spacers &amp; Angle</option>
      </select>
    </div>

    <div class="input-grid" style="margin-top: 12px;">
      <div class="input-group" id="fix-stem-angle-group">
        <label>Fixed Stem Angle <span class="unit">(¬∞ from steerer)</span> <span class="label-tip">&#9432;<span class="tip-text">The stem angle you want to keep fixed. The solver will find the stem length and spacer stack needed to hit your fit targets.</span></span></label>
        <input type="number" id="fix-stem-angle" value="-6" step="1">
      </div>
      <div class="input-group hidden" id="fix-spacers-group">
        <label>Fixed Spacer Stack <span class="unit">(mm)</span> <span class="label-tip">&#9432;<span class="tip-text">The spacer stack you want to keep fixed. The solver will find the stem length and angle needed to hit your fit targets.</span></span></label>
        <input type="number" id="fix-spacers" value="20" step="5">
      </div>
      <div class="input-group hidden" id="fix-stem-length-group">
        <label>Fixed Stem Length <span class="unit">(mm)</span> <span class="label-tip">&#9432;<span class="tip-text">The stem length you want to keep fixed. The solver will find the spacer stack and stem angle needed to hit your fit targets.</span></span></label>
        <input type="number" id="fix-stem-length" value="100" step="5">
      </div>
    </div>

    <div class="reverse-results" id="reverse-results"></div>
    <p class="note" id="reverse-note"></p>
  </div>

  <!-- Forward Results -->
  <div class="card calculator-view" id="card-results">
    <h2>Fit Results</h2>
    <div class="results-grid" id="forward-results"></div>
    <p class="note" id="forward-note"></p>
  </div>

  <!-- SVG Diagram -->
  <div class="card diagram-container calculator-view">
    <h2>Geometry Diagram</h2>
    <svg id="bike-svg" viewBox="0 0 800 500" xmlns="http://www.w3.org/2000/svg"></svg>
  </div>

  <!-- Compare Frames View -->
  <div class="card hidden" id="compare-view" style="grid-column: 1 / -1;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
      <h2 style="margin:0;">Compare Frames</h2>
      <button class="preset-trigger-btn" onclick="setMode('forward')">&larr; Back to Calculator</button>
    </div>
    <div class="compare-selectors">
      <div class="compare-frame-selector frame-a">
        <h3>Frame A</h3>
        <div class="compare-frame-label" id="compare-label-a">No frame selected</div>
        <button class="preset-trigger-btn" onclick="openComparePresetModal('a')">Select Frame</button>
      </div>
      <div class="compare-frame-selector frame-b">
        <h3>Frame B</h3>
        <div class="compare-frame-label" id="compare-label-b">No frame selected</div>
        <button class="preset-trigger-btn compare-btn" onclick="openComparePresetModal('b')">Select Frame</button>
      </div>
    </div>
    <div class="compare-diagram">
      <svg id="compare-svg" viewBox="0 0 800 500" xmlns="http://www.w3.org/2000/svg"></svg>
      <div class="compare-legend">
        <span class="legend-item"><span class="legend-swatch" style="background:var(--accent)"></span> Frame A</span>
        <span class="legend-item"><span class="legend-swatch" style="background:var(--green)"></span> Frame B</span>
      </div>
    </div>
    <div id="compare-table"></div>
  </div>
</main>

<div class="modal-overlay" id="instructions-modal" onclick="if(event.target===this)this.classList.remove('open')">
  <div class="modal">
    <button class="modal-close" onclick="document.getElementById('instructions-modal').classList.remove('open')">&times;</button>
    <h2><span style="color:var(--accent)">Bike Fit</span> <span style="color:var(--text)">Cockpit Calculator</span></h2>
    <p>This tool helps you translate professional bike fit measurements into the specific components you need for a given frame, or check what fit numbers a particular setup produces. Frame geometry for many popular bikes is available via the built-in presets. For bikes not included, you can find geometry data on the <a href="https://geometrygeeks.bike" target="_blank" rel="noopener" style="color:var(--accent)">geometrygeeks.bike</a> database and enter the values manually.</p>

    <h3>How it works</h3>
    <p>All calculations use the geometric relationship between the bottom bracket (BB), saddle, and hood positions. The frame's stack, reach, seat tube angle, and head tube angle define the skeleton. Components (stem, spacers, handlebars) extend from the top of the head tube to the hood position along the steerer and stem axes using trigonometry.</p>

    <h3>Measure to: Hoods / Handlebars</h3>
    <p>Use the toggle next to the Components and Fit Targets headings to switch between measuring to the <strong>Hoods</strong> (brake hood position, accounting for handlebar reach) or the <strong>Handlebars</strong> (top of the bar at the stem clamp, ignoring handlebar reach). All fit results and the diagram update accordingly.</p>

    <h3>Mode 1: Components to Fit</h3>
    <p>Enter your frame geometry and the components you have (or are considering). The calculator shows the resulting fit numbers:</p>
    <ul>
      <li><strong>Saddle-to-Reach</strong> &mdash; horizontal distance from saddle to the measurement point</li>
      <li><strong>Saddle-to-Drop</strong> &mdash; how far the measurement point sits below the saddle (positive = lower)</li>
    </ul>

    <h3>Mode 2: Fit Targets to Components</h3>
    <p>Enter the fit targets from your bike fitter along with your frame geometry. The system of equations has three unknowns (stem length, stem angle, spacer stack) but only two constraints (reach and drop), so you fix one variable and solve for the other two:</p>
    <ul>
      <li><strong>Fix Stem Angle</strong> &mdash; choose your preferred stem angle, get the required stem length and spacer stack</li>
      <li><strong>Fix Spacer Stack</strong> &mdash; set your spacer height, get the required stem length and angle</li>
      <li><strong>Fix Stem Length</strong> &mdash; pick a stem length, get the required spacers and angle</li>
    </ul>

    <h3>Frame presets</h3>
    <p>Click the <strong>Presets</strong> button to open a searchable overlay with multiple bike brands and models. Each model lists its available sizes &mdash; select one to instantly load the frame geometry. Dimmed sizes are bikes we haven&rsquo;t added geometry data for yet. You can always enter or adjust the geometry fields manually for any frame.</p>

    <h3>Compare Frames</h3>
    <p>Click <strong>Compare Frames</strong> to select two frames from the database and see their geometry overlaid on the same diagram with a side-by-side comparison table.</p>

    <h3>Key inputs</h3>
    <ul>
      <li><strong>Stack &amp; Reach</strong> &mdash; from the frame geometry chart (mm)</li>
      <li><strong>Seat Tube Angle (STA)</strong> &mdash; angle from horizontal (typically 72&ndash;76&deg;)</li>
      <li><strong>Head Tube Angle (HTA)</strong> &mdash; angle from horizontal (typically 71&ndash;74&deg;)</li>
      <li><strong>Stem Angle</strong> &mdash; relative to the steerer perpendicular (0&deg; = perpendicular, negative = angled down)</li>
      <li><strong>Saddle Height</strong> &mdash; measured along the seat tube from BB centre to the saddle Biomechanical Reference Point (BRP). The BRP is the designed sit-bone contact point, usually marked by the manufacturer or at the deepest point of the saddle profile (mm)</li>
      <li><strong>Saddle Setback</strong> &mdash; horizontal offset of the saddle BRP behind the seatpost clamp (mm)</li>
      <li><strong>Handlebar Reach</strong> &mdash; horizontal distance from bar clamp to hoods (mm, from bar spec sheet)</li>
    </ul>

    <h3>Tips</h3>
    <ul>
      <li>Yellow warnings appear when a solved value is outside typical commercially available ranges</li>
      <li>If the reverse solver shows negative spacers, the frame likely has too much stack for your fit targets</li>
      <li>The diagram updates live as you adjust inputs</li>
      <li>Use the Presets button to quickly load frame geometry for popular bikes and compare sizes</li>
    </ul>
  </div>
</div>

<div class="modal-overlay" id="preset-modal" onclick="if(event.target===this)this.classList.remove('open')">
  <div class="modal preset-modal">
    <button class="modal-close" onclick="document.getElementById('preset-modal').classList.remove('open')">&times;</button>
    <h2>Select Frame Preset</h2>
    <input type="text" class="preset-search" id="preset-search" placeholder="Search brands or models..." oninput="renderPresetModal()">
    <div id="preset-list"></div>
    <p style="margin-top:16px; font-size:0.8rem; color:var(--text-dim); text-align:center;">To suggest more bikes or if any data is incorrect email jakestuchbury (at) gmail.com</p>
  </div>
</div>

<footer>
  &copy; 2026 Jake Stuchbury-Wass
</footer>

<script src="bike-database.js"></script>
<script src="app.js"></script>

</body>
</html>